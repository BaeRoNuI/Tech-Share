# 개선을 위해 미리 알아본 로깅 관리 Best Practice

# 개요

## 로그 관리 개선의 필요성을 느꼈던 부분

현업에서 유지보수하고 있는 ERP의 로그 관리에는 두 가지의 큰 문제가 있었습니다.

### 1. 불필요한 로그가 너무 많거나 필요한 정보가 안 나오는 경우가 있습니다



**개발 중** ​에서 나온 로그는
- 첫 화면에서 로그인 후 메인화면 접속만 했는데도 4500줄이 나오거나 한 페이지에 접속할 때마다 1000 ~ 3000줄씩 로그가 찍힙니다.
  - 추가/수정의 경우에도 비슷한 양의 로그가 출력됩니다.

이렇게 많은 로그의 구성은 이랬습니다.
1. Request 정보 (preHandler)
   - ```
       +--------------------------------------------------------------------------+
       +                    Interceptor Information(preHandle)                    +
       +--------------------------------------------------------------------------+
       - URI와 URL 정보
       - X-Requested-With 정보
       - Query String 정보
       - 세션이 null인지 체크한 결과
       +--------------------------------------------------------------------------+
       +                          XMLHttpRequest : ajax                           +
       +--------------------------------------------------------------------------+    
2. 무엇을 위한 건지 모르겠는 개행
   - ```
     .
     .
     .
     .
     .
     .
     .
     .
     .
     .
3. API 로그
   - 파라미터 정보
   - 공백으로 표시되는 모델 정보
     - ```
       DEBUG : <코드/샘플/리스트> model : {}
     - 그런데 이게 무슨 모델인지, 모델의 정보가 출력되는 걸 본 적이 없습니다
   - 넘어갈 View URL
     - 막상 보면 URL이 아니고 URI입니다
4. 쿼리 실행 시 찍혀나오는 로그
   - `Preparing:` 디버그 로그
     - 쿼리의 조건에서 파라미터로 들어갈 항목에 `?`로 표시됨
   - `Parameters:` 디버그 로그
     - 쿼리에 수행되는 파라미터들이 `Preparing`의 `?` 순서대로 출력
   - 실행된 SQL문
   - 결과 출력 로그
     - 예) select를 했을 때
       - ```
         |-------|----------|---------------|-----------|-----------|  [jdbc.resultsettable]
         |NO    |NAME |DEPT      |SAL |HOBBY   |  [jdbc.resultsettable]
         |-------|----------|-----------|-----------|  [jdbc.resultsettable]
         |10     |홍길동       |개발팀         |1000000        | [null] |  [jdbc.resultsettable]
         |-------|----------|---------------|-----------|---------|  [jdbc.resultsettable]
5. 반환될 정보 관련 로그 (postHandler)
   - 넘어갈 URI/URL 주소
   - 반환될 모델 정보 간판(?)
     - ```
       DEBUG: ##### Interceptor Information(postHandle) #####
   - 반환될 모델의 이름 목록들
     - ```
       +--------------------------------------------------------------------------+
       + ViewName : 'home'
       + Model : name = 'nameList'
       + Model : name = 'deptList'
       + ...
       +--------------------------------------------------------------------------+
6. 가끔씩 출력되는 HTML 문자열 로그
   - 메뉴 목록을 서블릿 형태로 뱉어냄

**로컬/개발 서버에서 한 페이지로 진입할 때마다** 한 API당 200줄 되는 로그에 API가 1~20번 넘게 호출되어 **약 2천 ~ 4천 줄의 로그가 쌓입니다.**
이에 따라 이렇게 로그가 쌓이게 되면 개발 중에도 많은 불편을 야기합니다.


**운영** 에서 나오는 로그의 구성은 다음과 같습니다.

1. Request 정보 (preHandler)
   - ```
       +--------------------------------------------------------------------------+
       +                    Interceptor Information(preHandle)                    +
       +--------------------------------------------------------------------------+
       - URI와 URL 정보
       - X-Requested-With 정보
       - Query String 정보
       - 세션이 null인지 체크한 결과
       +--------------------------------------------------------------------------+
       +                          XMLHttpRequest : ajax                           +
       +--------------------------------------------------------------------------+  
2. 무엇을 위한 건지 진짜 모르겠는 개행
   - ```
     .
     .
     .
     .
     .
     .
     .
     .
     .
     .
3. 가끔씩 출력되는 Error 로그
   - 원인을 알 수 없는 에러 로그
     - ```
       심각: ##### Interceptor Information(afterCompletion) #####
       +--------------------------------------------------------------------------+
       + Exception occurred! (ERROR MESSAGE) Connection reset by peer: socket write error
       +--------------------------------------------------------------------------+
     
       <2023. 1. 15 오후 1시 36분 44초 KST> <Error> <HTTP> <BEA-123456> <[ServletContext@1083261234[app:pay module:pay path:null spec-version:3.0]] Root cause of ServletException.
       org.apache.tiles.impl.CannotRenderException: Connection reset by peer: socket write error
       	at org.apache.tiles.impl.BasicTilesContainer.render(BasicTilesContainer.java:692)
       	at org.apache.tiles.impl.BasicTilesContainer.render(BasicTilesContainer.java:644)
       	at org.apache.tiles.impl.BasicTilesContainer.render(BasicTilesContainer.java:627)
       	at org.apache.tiles.impl.BasicTilesContainer.render(BasicTilesContainer.java:321)
       	at org.springframework.web.servlet.view.tiles2.TilesView.renderMergedOutputModel(TilesView.java:124)
       	Truncated. see log file for complete stacktrace
       Caused By: java.net.SocketException: Connection reset by peer: socket write error
       	at java.net.SocketOutputStream.socketWrite0(Native Method)
       	at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)
       	at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
       	at com.javaservice.lwst.SocketWrapper$OutputStreamWrap.write(Unknown Source)
       	at weblogic.servlet.internal.ChunkOutput.writeChunkTransfer(ChunkOutput.java:577)
       	Truncated. see log file for complete stacktrace
       > 
4. 결제 등 중요한 처리에 대한 입력/반환 값들
   - `<결제@process> 키 : 값`을 한 줄에 표시되며, 어느 곳에서 입력/반환된 값인지는 바로 위에서 확인할 수 있습니다.
   - 그러나 만약 여러 명의 사용자가 같은 API를 동시에 호출하게 되면 그 API가 누구로부터 호출됐는지, 누가 호출해서 입력/반환된 정보인지 판별하기 힘들어집니다.
   - 사용자 수가 적다고 하더라도 안심할 수는 없습니다. 문제가 발생했는데 기묘하게 동시에 같은 API가 호출된 상황이라면 문제를 해결하기 난감해집니다.
5. GridData?
   - ```
     GridData [list = [{NAME=홍길동, ... }]]
   - Grid가 어떤 그리드를 뜻하는지, 그 안에 배열과 JSON 형태로 감싸여진 list라는 데이터는 어떤 결과의 데이터인지 모릅니다.
   - 그 위에 `1번`과 같이 Request 정보가 나오지만 어느 API로 호출이 된 건지에 대한 정보가 없는 경우도 있습니다.

운영 로그는 한꺼번에 로그 내용을 모으는지라 용량도 많은데 **개행도 너무 많아서 분석하기가 어렵**습니다. 그렇다고 오류가 발생했을 때 **원인을 분석할 수 있는 파라미터나 세션값 등의 정보가 나오지도 않았습니다.**

`로컬/개발 로그`에서는 한 API 호출에 너무 많은 정보가, `운영 로그`에서는 정작 필요한 데이터가 안 나오는 경우가 주를 이루고 있었습니다.


### 2. 문제가 발생했을 때 원인을 파악하기 힘들었습니다

불필요한 로그가 너무 많거나 필요한 정보가 안 나오는 경우에 더해서, 문제가 발생했을 때 원인을 파악하기 힘들었습니다.

운영서버의 로그는 서버 재시작을 하거나 일정 용량이 찼을 때 새 로그로 기록되고 있었지만, 용량이 다 차지 않을 때 재시작을 하면 새 로그로 초기화됩니다.

만약 운영 서버를 재기동한지 한참 뒤에 오류났다고 하겠습니다. 그 사이에 다른 개발자가 원인을 분석하지 않고 바로 고친 뒤 서버를 재시작한다면, 특히나 용량이 다 차지 않았을 때는 그 오류났던 기록이 초기화됩니다.
그렇게 되면 다시 그 오류가 발생할 때까지 기다릴 수밖에 없죠. 문제를 방생하는 셈이 됩니다.

모니터링 툴(APM)을 사용하고 있어 그 오류가 발생했던 클라이언트 정보(IP, HTTP User-Agent) 등을 확인할 수 있었지만, 수행됐던 쿼리는 파라미터가 `?`나 `$`로 표시되고, 그 값들은 다음 줄의 로그에 배열처럼 나열되어 있었습니다. 또한 API 내에 기록해둔 로그도 볼 수 없었습니다.

그 문제를 기존에는 실제 고객에게 양해를 구하고 직접 운영 서버에서 디버깅하며 원인을 파악하고 있었습니다. 아무리 ERP라고 해서 특정한 고객들에게 양해를 구할 수 있다고 해도 그 고객의 입장에서는 일도 진척이 안 되고, 그렇게 디버깅을 해서 해결을 못 하면 서비스에 대한 신뢰가 하락할 수밖에 없습니다.

운영 환경에서의 디버깅을 차단하고 로그 관리에 힘써 실제 문제가 발생해도 정확한 원인을 파악할 수 있는 방법이 필요했습니다. 그리고 그 방법으로써 Best Practice를 적용하고자 로깅 프레임워크의 필요성, 이론, 다른 분들의 로그 관리 방법을 알아봤습니다.

## 로깅 Best Practice

### 로깅이 뭘까? 왜 필요할까?


### 로깅은 어떻게 하는 걸까? 로깅하는 방법에 대한 종류가 있을까?


### 다들 로그 관리는 어떻게 하고 있을까?




# References

- [왜 System out println 대신 log를 써야할까](https://www.youtube.com/watch?v=9TX9TS0o3KI)
- [[10분 테코톡] 검프의 Logging(로깅) #1](https://www.youtube.com/watch?v=1MD5xbwznlI)
- [[10분 테코톡] 검프의 Logging(로깅) #2](https://www.youtube.com/watch?v=JqZzy7RyudI)
- [6년차 개발자가 알려주는 개발용어 6. 로깅](https://www.youtube.com/watch?v=1iDtAqikZNA)
- [자바 로깅 라이브러리(log4j/logback/log4j2) 종류 및 설명](https://www.youtube.com/watch?v=mCuaslp_7po)
- [로깅과 로그관리 + 분산 추적](https://www.youtube.com/watch?v=c7V52EMKXQM)
- [[10분 테코톡] 무늬의 로깅](https://www.youtube.com/watch?v=MxxeKXydn4A)
- [SLASH 23 - 분산 추적 체계 & 로그 중심으로 Observability 확보하기](https://www.youtube.com/watch?v=Ifz0LsfAG94)
- [로그는 반드시 필요한 내용만 찍자](https://yangbongsoo.gitbook.io/study/undefined/log)
- [SLF4J Logger 사용법 & 잘못된 사용법: Binding Parameters, Logging Exception Stack Trace](https://dveamer.github.io/backend/HowToUseSlf4j.html)
- [일반로그라는 의미가 정확히 무엇인가요?](https://www.inflearn.com/questions/982462/%EC%9D%BC%EB%B0%98%EB%A1%9C%EA%B7%B8%EB%9D%BC%EB%8A%94-%EC%9D%98%EB%AF%B8%EA%B0%80-%EC%A0%95%ED%99%95%ED%9E%88-%EB%AC%B4%EC%97%87%EC%9D%B8%EA%B0%80%EC%9A%94)
- https://blog.naver.com/watch_all/222001269607
- [로그 데이터로 유저 이해하기](https://frost-witch-afb.notion.site/YOUTHCON-23-a026c94d997e46db9396283ed869a922)
- [로깅을 어떻게 해야할까?](https://onduway.tistory.com/86)
- [[Spring] 스프링의 로깅](https://emgc.tistory.com/129)
- [백엔드 로그 형식을 어떻게 정해야 할까요?](https://okky.kr/questions/576033)
- https://logging.apache.org/log4j/2.x/manual/layouts.html
- [로그를 잘 남기자](https://planjang.tistory.com/232)
- [개발자라면 꼭 해야하는 Log 관리, Slf4j Logger](https://github.com/esperar/estudy/blob/master/Back-End/backend/logger.md)
- [사내 이벤트 로깅 시스템을 정비하고 패키지화 하기](https://xionwcfm.tistory.com/446#google_vignette)
- [1. 효율적으로 로그 모니터링하기 - 로그 레벨 구분하기](https://jojoldu.tistory.com/712)
- [운영 로그와 디버그 로그 분리하기](https://jojoldu.tistory.com/773)
- [어떻게 로깅할 것인가](https://medium.com/modulabs/%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A1%9C%EA%B9%85%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-40d842fe1f8d)
- [11장 로깅 - 애플리케이션의 동작을 기록한다](https://wikidocs.net/158639)
- [backend logging 시스템 구축](https://dexlee.tistory.com/228)
- [팀 로깅 전략 세우기](https://velog.io/@idonymyeon/%ED%8C%80-%EB%A1%9C%EA%B9%85-%EC%A0%84%EB%9E%B5-%EC%84%B8%EC%9A%B0%EA%B8%B0-prnri6hn)
- [백엔드 웹 개발 노트6.1 - 로깅](https://kkminseok.github.io/posts/basicSpring6_1/)
- [1) 로깅이란?](https://m.boostcourse.org/web326/lecture/59005)
- [우린 어떤 로그를 써야할까?](https://velog.io/@tco0427/%EC%9A%B0%EB%A6%B0-%EC%96%B4%EB%96%A4-%EB%A1%9C%EA%B7%B8%EB%A5%BC-%EC%8D%A8%EC%95%BC%ED%95%A0%EA%B9%8C)
- [[강변의 Java게임프로그래밍] 5 DAY - System.out.println이여!](https://blog.naver.com/lawintext/220835248657)
- [29CM 로그 수집 시스템 소개](https://medium.com/29cm/29cm-%EB%A1%9C%EA%B7%B8-%EC%88%98%EC%A7%91-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%86%8C%EA%B0%9C-e7955d7deec6)
- [[Java] System.out.println() 동작원리 native method까지 까보기](https://code-run.tistory.com/8)
- [How System.out.println() Works Internally in Java?](https://www.youtube.com/watch?v=bNLj8zsXaRs)